stages:
  - build
  - test
  - publish

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  GIT_STRATEGY: fetch
  # Docker image name in GitLab registry
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  DOCKER_BUILDKIT: "1"

default:
  tags:
    - kcni-docker

.default_before_script: &default_before_script
  - python --version
  - pip --version
  - pip install --upgrade pip build twine

# ============================================================
# Python Wheel Build
# ============================================================

build:wheel:
  stage: build
  image: python:3.13-slim
  before_script:
    - *default_before_script
  script:
    - python -m build
    - ls -l dist
  artifacts:
    paths:
      - dist/*.whl
      - dist/*.tar.gz
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

install:test:
  stage: test
  image: python:3.13-slim
  needs: ["build:wheel"]
  before_script:
    - pip install --upgrade pip
  script:
    - pip install dist/*.whl
    - xnatio --help
    - xio apply-label-fixes --help
  rules:
    - if: $CI_COMMIT_BRANCH

publish:gitlab:
  stage: publish
  image: python:3.13-slim
  needs: ["build:wheel"]
  before_script:
    - *default_before_script
  script:
    - TWINE_USERNAME=gitlab-ci-token TWINE_PASSWORD="$CI_JOB_TOKEN" twine upload --repository-url "$CI_API_V4_URL/projects/$CI_PROJECT_ID/packages/pypi" dist/*
  rules:
    - if: $CI_COMMIT_TAG

# ============================================================
# Docker Image Build
# ============================================================

build:docker:
  stage: build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $IMAGE_NAME:$CI_COMMIT_SHORT_SHA .
    - docker push $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

test:docker:
  stage: test
  image: docker:24
  services:
    - docker:24-dind
  needs: ["build:docker"]
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker run --rm $IMAGE_NAME:$CI_COMMIT_SHORT_SHA --help
    - docker run --rm $IMAGE_NAME:$CI_COMMIT_SHORT_SHA apply-label-fixes --help
  rules:
    - if: $CI_COMMIT_BRANCH
    - if: $CI_COMMIT_TAG

# Publish :latest tag on main branch
publish:docker-latest:
  stage: publish
  image: docker:24
  services:
    - docker:24-dind
  needs: ["test:docker"]
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker tag $IMAGE_NAME:$CI_COMMIT_SHORT_SHA $IMAGE_NAME:latest
    - docker push $IMAGE_NAME:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "main"

# Publish tagged releases
publish:docker-release:
  stage: publish
  image: docker:24
  services:
    - docker:24-dind
  needs: ["test:docker"]
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker tag $IMAGE_NAME:$CI_COMMIT_SHORT_SHA $IMAGE_NAME:$CI_COMMIT_TAG
    - docker push $IMAGE_NAME:$CI_COMMIT_TAG
  rules:
    - if: $CI_COMMIT_TAG
