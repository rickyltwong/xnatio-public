# docker-compose.yml
#
# Local development and testing for xnatio Docker image
#
# Usage:
#   # Build the image locally
#   docker-compose build
#
#   # Or pull from GitHub Container Registry
#   docker-compose pull
#
#   # Dry-run label fixes (reads from .env file)
#   docker-compose run --rm xnatio apply-label-fixes /config/patterns.json -v
#
#   # Execute label fixes
#   docker-compose run --rm xnatio apply-label-fixes /config/patterns.json --execute -v
#
#   # Run any CLI command
#   docker-compose run --rm xnatio --help
#   docker-compose run --rm xnatio list-scans PROJECT SUBJECT SESSION -v
#
#   # Upload DICOM (mount data directory)
#   docker-compose run --rm -v /path/to/data:/data:ro xnatio \
#     upload-dicom PROJECT SUBJECT SESSION /data/dicoms.zip -v

services:
  xnatio:
    # Use pre-built image from GHCR (recommended for production)
    image: ghcr.io/rickyltwong/xnatio:latest
    # Or build locally for development:
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    environment:
      # Required: XNAT connection (set in .env file or export before running)
      - XNAT_SERVER=${XNAT_SERVER:?XNAT_SERVER is required}
      - XNAT_USERNAME=${XNAT_USERNAME:?XNAT_USERNAME is required}
      - XNAT_PASSWORD=${XNAT_PASSWORD:?XNAT_PASSWORD is required}
      # Optional: TLS verification (default: true)
      - XNAT_VERIFY_TLS=${XNAT_VERIFY_TLS:-true}
      # Optional: DICOM C-STORE settings
      - XNAT_DICOM_HOST=${XNAT_DICOM_HOST:-}
      - XNAT_DICOM_PORT=${XNAT_DICOM_PORT:-8104}
      - XNAT_DICOM_CALLED_AET=${XNAT_DICOM_CALLED_AET:-XNAT}
      - XNAT_DICOM_CALLING_AET=${XNAT_DICOM_CALLING_AET:-XNATIO}
    volumes:
      # Mount config directory for patterns.json (optional)
      - ./config:/config:ro
      # Mount data directory for uploads/downloads (optional, add as needed)
      # - /path/to/data:/data:ro
    # Override entrypoint for debugging
    # entrypoint: ["/bin/bash", "-c", "sleep infinity"]
